<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{font-family:monospace;background:#1e1e2e;color:#cdd6f4;margin:0;padding:0}
h1{padding:10px;text-align:center;color:#89b4fa}
.container{padding:20px}
input,button{padding:6px 10px;margin:4px;border-radius:6px;border:none;font-family:monospace;font-size:12px}
input{width:150px}
button{cursor:pointer;background:#a6e3a1;color:#1e1e2e;font-weight:700}
table{width:100%;border-collapse:collapse;margin-top:10px}
th,td{padding:6px;border:1px solid #45475a;text-align:center}
th{background:#11111b}
td button{background:#f38ba8;color:#1e1e2e;font-weight:600;margin:2px;padding:4px 6px}
#output{margin-top:10px;color:#f38ba8;font-size:12px}
</style>
</head>
<body>
<h1>Admin Panel</h1>
<div class="container">
  <div>
    Admin Password: <input type="password" id="adminKey" placeholder="Enter password">
    <button onclick="refreshKeys()">Refresh Keys</button>
  </div>
  <div style="margin-top:10px;">
    New Key: <input type="text" id="newKey" placeholder="KEY1">
    Duration (min): <input type="number" id="keyTime" value="10" style="width:60px">
    <button onclick="createKey()">Create</button>
  </div>
  <table>
    <thead>
      <tr><th>Key</th><th>Status</th><th>Expires</th><th>Actions</th></tr>
    </thead>
    <tbody id="keyTable"></tbody>
  </table>
  <div id="output"></div>
</div>

<script>
const workerAdminUrl = 'https://mathspacekey.joshua-watson.workers.dev/';

async function callAdmin(action,key,extra=''){
  const adminKey = document.getElementById('adminKey').value.trim();
  if(!adminKey) return alert('Enter admin password!');
  const url = `${workerAdminUrl}?action=${encodeURIComponent(action)}&key=${encodeURIComponent(key)}${extra}`;
  const resp = await fetch(url, { headers: {'X-Admin-Key': adminKey} });
  return resp.text();
}

async function refreshKeys(){
  const tbody = document.getElementById('keyTable');
  tbody.innerHTML = '';
  const adminKey = document.getElementById('adminKey').value.trim();
  if(!adminKey) return;
  try{
    const resp = await fetch(`${workerAdminUrl}?action=list`, { headers: {'X-Admin-Key': adminKey} });
    if (!resp.ok) throw new Error(resp.statusText);
    const keys = await resp.json();
    keys.forEach(k=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${k.name}</td>
        <td>${k.status==='pending'?'Pending activation':k.status}</td>
        <td>${k.expires?new Date(k.expires).toLocaleString():''}</td>
        <td>
          <button onclick="closeKey('${encodeURIComponent(k.name)}')">Close</button>
          <button onclick="extendKey('${encodeURIComponent(k.name)}')">Extend</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
    document.getElementById('output').textContent = 'Keys refreshed';
  }catch(e){
    document.getElementById('output').textContent = 'Error: '+e;
  }
}

async function createKey(){
  const keyName = document.getElementById('newKey').value.trim();
  const time = document.getElementById('keyTime').value;
  if(!keyName) return alert('Enter key name!');
  const res = await callAdmin('create', keyName, `&time=${time}`);
  document.getElementById('output').textContent = res;
  refreshKeys();
}

async function closeKey(key){
  const res = await callAdmin('close', decodeURIComponent(key));
  document.getElementById('output').textContent = res;
  refreshKeys();
}

async function extendKey(key){
  const minutes = prompt('Enter minutes to extend:', 10);
  if (minutes === null) return;
  const res = await callAdmin('extend', decodeURIComponent(key), `&time=${minutes}`);
  document.getElementById('output').textContent = res;
  refreshKeys();
}
</script>
</body>
</html>
