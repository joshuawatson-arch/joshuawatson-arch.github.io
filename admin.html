<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AutoSolver Admin Panel</title>
<style>
body { font-family: Arial, sans-serif; max-width: 800px; margin: auto; padding: 20px; }
input, button { padding: 5px; margin: 5px; }
table { border-collapse: collapse; width: 100%; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
th { background: #eee; }
pre { background: #eee; padding: 10px; white-space: pre-wrap; }
</style>
</head>
<body>
<h1>AutoSolver Admin Panel</h1>

<h2>Admin Login</h2>
<input type="password" id="adminKey" placeholder="Admin password">

<h2>Create New Key</h2>
<input type="text" id="newKey" placeholder="Key name, e.g., KEY1">
<input type="number" id="newTime" placeholder="Timer (minutes)" value="10">
<button onclick="createKey()">Create Key</button>

<h2>Manage Keys</h2>
<button onclick="refreshKeys()">Refresh List</button>
<table id="keysTable">
  <thead>
    <tr>
      <th>Key</th>
      <th>Status</th>
      <th>Expires At</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<pre id="output"></pre>

<script>
const workerAdminUrl = 'https://mathspacekey.joshua-watson.workers.dev/admin'
const output = document.getElementById('output')
const tbody = document.querySelector('#keysTable tbody')

// === Helper to call admin endpoint ===
async function callAdmin(action, key, extra='') {
  const adminKey = document.getElementById('adminKey').value
  if (!adminKey) return alert('Enter admin password')
  const url = `${workerAdminUrl}?action=${action}&key=${key}${extra}`
  const resp = await fetch(url, { headers: {'X-Admin-Key': adminKey} })
  return await resp.text()
}

// === Create new key ===
async function createKey() {
  const keyName = document.getElementById('newKey').value
  const time = document.getElementById('newTime').value || '10'
  if (!keyName) return alert('Enter a key name')
  try {
    const text = await callAdmin('create', keyName, `&time=${time}`)
    output.textContent = text
    refreshKeys()
  } catch(e) { output.textContent = 'Error: ' + e }
}

// === Refresh key list ===
async function refreshKeys() {
  tbody.innerHTML = ''
  const adminKey = document.getElementById('adminKey').value
  if (!adminKey) return
  try {
    // Example: store keys in an array in KV or fetch all keys you created
    // Here we simulate: KEY1 to KEY10 for demo; replace with your real key tracking if needed
    const keys = ['KEY1','KEY2','KEY3','KEY4','KEY5'] // replace with real key list
    for (let key of keys) {
      const status = await callAdmin('status', key)
      let expiresAt = ''
      let displayStatus = status
      if (!isNaN(status)) {
        expiresAt = new Date(parseInt(status)).toLocaleString()
        displayStatus = 'In Use'
      }
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td>${key}</td>
        <td>${displayStatus}</td>
        <td>${expiresAt}</td>
        <td>
          <button onclick="closeKey('${key}')">Close</button>
          <button onclick="extendKey('${key}')">Extend</button>
        </td>
      `
      tbody.appendChild(tr)
    }
  } catch(e) { output.textContent = 'Error refreshing keys: ' + e }
}

// === Close key ===
async function closeKey(key) {
  const text = await callAdmin('close', key)
  output.textContent = text
  refreshKeys()
}

// === Extend key ===
async function extendKey(key) {
  const minutes = prompt('Minutes to extend?', '10')
  if (!minutes) return
  const text = await callAdmin('extend', key, `&time=${minutes}`)
  output.textContent = text
  refreshKeys()
}

// Initial load
refreshKeys()
</script>
</body>
</html>
